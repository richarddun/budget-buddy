<!DOCTYPE html>
<html>
<head>
  <title>Budget Chat (SSE)</title>
  <script src="https://unpkg.com/htmx.org@1.9.2"></script>
  <script src="https://unpkg.com/htmx.org/dist/ext/sse.js"></script>
  <style>
    body { font-family: sans-serif; margin: 2em; background: #f8f8ff; }
    .chatbox { border: 1px solid #ccc; padding: 1em; margin-bottom: 1em; height: 400px; overflow-y: auto; background: #fff; border-radius: 6px; }
    .input { display: flex; gap: 1em; }
    input { flex: 1; padding: 0.5em; font-size: 1em; border-radius: 4px; border: 1px solid #ccc; }
    button { padding: 0.5em 1em; font-size: 1em; border-radius: 4px; border: none; background-color: #3367d6; color: white; cursor: pointer; }
    button:hover { background-color: #264aa4; }
    hr { border: 0; height: 1px; background: #ddd; margin: 1em 0; }
  </style>
</head>
<body hx-ext="sse">
  <h1>ðŸ’¬ Budget Chat</h1>

  <div id="chatbox" class="chatbox">
    {% include 'messages.html' %}
  </div>

  <form id="chat-form" hx-post="/htmx-chat" hx-target="#chatbox" hx-swap="beforeend">
    <input type="text" name="prompt" id="prompt" placeholder="Ask something..." autocomplete="off" required>
    <button type="submit">Send</button>
  </form>

  <div id="stream" sse-connect="">
    <p id="stream-content"></p>
  </div>

<script>
  htmx.logAll();
  document.body.addEventListener('htmx:afterSwap', function (evt) {
    console.log('[HTMX] afterSwap fired for:', evt.detail.target.id);
    if (evt.detail.target.id === "chatbox") {
      const prompt = document.getElementById('prompt').value;
      const streamDiv = document.getElementById('stream');
      const streamContent = document.getElementById('stream-content');

      console.log('[HTMX] Setting SSE stream for prompt:', prompt);
      streamContent.innerHTML = '';
      streamDiv.setAttribute('sse-connect', `/sse?prompt=${encodeURIComponent(prompt)}`);
      htmx.process(streamDiv); // ðŸ‘ˆ force SSE to activate!
      console.log('[HTMX] SSE manually triggered');
      console.log('[HTMX] sse-connect set to:', streamDiv.getAttribute('sse-connect'));
    }
  });

document.body.addEventListener('htmx:sseMessage', function(evt) {
  console.log('[HTMX] sseMessage received:', evt.detail.value);
  const streamContent = document.getElementById('stream-content');
  streamContent.innerHTML += evt.detail.value;
  console.log('[HTMX] Updated content:', streamContent.innerHTML);
});


  document.body.addEventListener('htmx:sseError', function(evt) {
    console.log('[HTMX] sseError:', evt);
    document.getElementById('stream-content').innerHTML += "<br><em>Error streaming response.</em>";
  });
</script>


<script>
  function testSSE(prompt) {
    const url = `/sse?prompt=${encodeURIComponent(prompt)}`;
    const eventSource = new EventSource(url);

    eventSource.onopen = () => console.log("[SSE] Connection opened:", url);
    eventSource.onerror = (e) => console.error("[SSE] Error:", e);
    eventSource.onmessage = (e) => console.log("[SSE] Message:", e.data);

    // If you're yielding specific events like 'done':
    eventSource.addEventListener("done", (e) => {
      console.log("[SSE] Done event:", e.data);
      eventSource.close();
    });
  }

  // Auto-trigger a manual SSE stream (just for debug)
  window.testSSE = testSSE;
</script>


</body>
</html>
