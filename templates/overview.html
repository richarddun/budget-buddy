<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Budget Buddy — Overview</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token }}">
    {% endif %}
    <style>
      :root {
        --bg: #0f172a; /* slate-900 */
        --panel: #111827; /* gray-900 */
        --card: #1f2937; /* gray-800 */
        --text: #e5e7eb; /* gray-200 */
        --muted: #9ca3af; /* gray-400 */
        --accent: #60a5fa; /* blue-400 */
      }
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; background: var(--bg); color: var(--text); }
      .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
      .back { display: inline-block; padding: 8px 12px; background: var(--accent); color: #06142b; border-radius: 6px; text-decoration: none; font-weight: 600; }
      .cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
      @media (max-width: 800px) { .cards { grid-template-columns: 1fr; } }
      .card { background: var(--card); border-radius: 10px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
      .label { font-size: 13px; color: var(--muted); margin-bottom: 6px; }
      .value { font-size: 28px; font-weight: 700; letter-spacing: 0.3px; }
      .muted { color: var(--muted); font-size: 12px; }
      .row { display: flex; align-items: center; gap: 10px; }
      .badge { display: inline-block; background: #374151; color: var(--muted); padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    </style>
  </head>
  <body>
    <script>window.APP_BASE = '{{ request.url_for("index") }}'.replace(/\/$/, '');</script>
    <script src="{{ request.url_for('static', path='sidebar.js') }}"></script>
    <div class="container">
      <div class="header">
        <h1 style="margin:0">Overview</h1>
        <a class="back" href="{{ request.url_for('index') }}">← Back to Chat</a>
      </div>
      <div class="cards" role="region" aria-label="Overview header cards">
        <div class="card" aria-labelledby="lbl-balance" aria-live="polite">
          <div id="lbl-balance" class="label">Total Cleared Balance</div>
          <div id="val-balance" class="value">—</div>
          <div class="muted" id="meta-updated"></div>
        </div>
        <div class="card" aria-labelledby="lbl-safe" aria-live="polite">
          <div id="lbl-safe" class="label">Safe To Spend Today</div>
          <div id="val-safe" class="value">—</div>
          <div class="muted">Buffer floor respected</div>
        </div>
        <div class="card" aria-labelledby="lbl-health" aria-live="polite">
          <div id="lbl-health" class="label">Health</div>
          <div class="row">
            <div id="val-health" class="value" aria-label="Health band">—</div>
            <div id="val-health-score" class="value" style="font-size:20px;color:var(--muted)">—</div>
          </div>
          <div class="muted">Based on buffer and cliff proximity</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px" aria-labelledby="lbl-quick-check">
        <div id="lbl-quick-check" class="label">Quick check — Can I spend X today?</div>
        <form id="spend-form" class="row" style="gap:8px" aria-describedby="spend-help">
          <label for="spend-amount-cents" class="muted" style="min-width:120px">Amount (cents)</label>
          <input id="spend-amount-cents" name="amount_cents" type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="1" required
                 placeholder="e.g. 2500" aria-required="true"
                 style="flex:1; background:#0b1222; color:var(--text); border:1px solid #374151; border-radius:6px; padding:8px 10px" />
          <button type="submit" style="background:#2563eb; color:white; border:none; border-radius:6px; padding:8px 12px; cursor:pointer">Check</button>
        </form>
        <div id="spend-help" class="muted" style="margin-top:6px">Enter an integer number of cents. Results respect your buffer floor.</div>
        <div id="spend-result" aria-live="polite" style="margin-top:10px"></div>
      </div>

      <div class="card" style="margin-top:12px" aria-labelledby="lbl-export">
        <div id="lbl-export" class="label">Questionnaire Export</div>
        <div class="row" style="gap:8px; align-items:center">
          <div class="muted">Pack:</div>
          <select id="q-pack" style="background:#0b1222; color:var(--text); border:1px solid #374151; border-radius:6px; padding:6px 8px">
            <option value="loan_application_basics">Loan Application Basics</option>
            <option value="affordability_snapshot">Affordability Snapshot</option>
          </select>
          <div class="muted">Format:</div>
          <select id="q-format" style="background:#0b1222; color:var(--text); border:1px solid #374151; border-radius:6px; padding:6px 8px">
            <option value="both">CSV + PDF</option>
            <option value="csv">CSV only</option>
            <option value="pdf">PDF only</option>
          </select>
          <button id="btn-export" type="button" style="background:#2563eb; color:white; border:none; border-radius:6px; padding:8px 12px; cursor:pointer">Export</button>
        </div>
        <div id="export-help" class="muted" style="margin-top:6px">Generates export files under <code>/exports</code>. Links will appear below.</div>
        <div id="export-result" aria-live="polite" style="margin-top:10px"></div>
      </div>
    </div>
    <script>
      function fmtCents(cents) {
        const sign = cents < 0 ? '-' : '';
        const abs = Math.abs(cents);
        return sign + '$' + (abs/100).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
      }
      let __overview = null;
      async function loadOverview() {
        try {
          const res = await fetch('{{ request.url_for("index") }}api/overview'.replace(/\/$/, ''));
          if (!res.ok) throw new Error('Failed to load overview');
          const d = await res.json();
          __overview = d;
          document.getElementById('val-balance').textContent = fmtCents(d.current_balance_cents);
          document.getElementById('val-safe').textContent = fmtCents(d.safe_to_spend_today_cents);
          document.getElementById('val-health').textContent = d.health_band;
          document.getElementById('val-health').setAttribute('aria-label', `Health band ${d.health_band}`);
          document.getElementById('val-health-score').textContent = ` ${d.health_score}`;
          const meta = d.snapshot?.created_at ? `Last snapshot: ${d.snapshot.created_at}${d.snapshot.is_stale ? ' · stale' : ''}` : 'No snapshot yet';
          document.getElementById('meta-updated').innerHTML = `<span class="badge">${meta}</span>`;
        } catch (e) {
          document.getElementById('val-balance').textContent = 'N/A';
          document.getElementById('val-safe').textContent = 'N/A';
          document.getElementById('val-health').textContent = 'N/A';
          document.getElementById('val-health-score').textContent = '';
          document.getElementById('meta-updated').innerHTML = '<span class="badge">Unable to load overview</span>';
        }
      }
      loadOverview();

      // Quick simulate-spend form
      const spendForm = document.getElementById('spend-form');
      const spendInput = document.getElementById('spend-amount-cents');
      const spendResult = document.getElementById('spend-result');
      function csrfHeader() {
        const meta = document.querySelector('meta[name="csrf-token"]');
        return meta ? { 'X-CSRF-Token': meta.getAttribute('content') } : {};
      }
      function adminHeader() {
        try {
          const tok = localStorage.getItem('adminToken') || localStorage.getItem('admin_token');
          return tok ? { 'X-Admin-Token': tok } : {};
        } catch { return {}; }
      }
      spendForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const raw = (spendInput?.value || '').trim();
        spendResult.textContent = '';
        if (!raw) { spendResult.textContent = 'Please enter an amount in cents.'; return; }
        if (!/^[0-9]+$/.test(raw)) { spendResult.textContent = 'Amount must be an integer number of cents.'; return; }
        const amount = Number(raw);
        if (!Number.isFinite(amount) || amount < 0) { spendResult.textContent = 'Amount must be a non-negative integer.'; return; }
        const today = new Date(); today.setHours(0,0,0,0);
        const payload = {
          date: new Date(today.getTime() - today.getTimezoneOffset()*60000).toISOString().slice(0,10),
          amount_cents: amount,
          buffer_floor: (__overview && typeof __overview.buffer_floor_cents === 'number') ? __overview.buffer_floor_cents : 0,
          mode: 'deterministic',
          horizon_days: 120,
        };
        try {
          const res = await fetch('{{ request.url_for("index") }}api/forecast/simulate-spend'.replace(/\/$/, ''), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...csrfHeader() },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            const j = await res.json().catch(() => ({}));
            throw new Error(j.detail || 'Request failed');
          }
          const out = await res.json();
          const dec = out.decision || {};
          const safe = !!dec.safe;
          const msg = [
            safe ? '✅ Safe' : '❌ Unsafe',
            ` · Max safe today: ${fmtCents(dec.max_safe_today_cents ?? 0)}`,
            dec.new_min_balance_date ? ` · Min on ${dec.new_min_balance_date}: ${fmtCents(dec.new_min_balance_cents ?? 0)}` : ''
          ].join('');
          spendResult.innerHTML = msg + (dec.notes ? `<div class="muted" style="margin-top:4px">${dec.notes}</div>` : '');
        } catch (err) {
          spendResult.textContent = String(err.message || err);
        }
      });

      // Minimal Questionnaire Export wiring
      const exportBtn = document.getElementById('btn-export');
      const exportResult = document.getElementById('export-result');
      exportBtn?.addEventListener('click', async () => {
        exportResult.textContent = '';
        const pack = (document.getElementById('q-pack')?.value || 'loan_application_basics');
        const format = (document.getElementById('q-format')?.value || 'both');
        const payload = { pack, period: '3m_full', format };
        try {
          const res = await fetch('{{ request.url_for("index") }}api/q/export'.replace(/\/$/, ''), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...csrfHeader(), ...adminHeader() },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            const j = await res.json().catch(() => ({}));
            throw new Error(j.detail || 'Export failed');
          }
          const out = await res.json();
          const links = [];
          if (out.csv_url) links.push(`<a href="${out.csv_url}" target="_blank" rel="noopener">CSV</a>`);
          if (out.pdf_url) links.push(`<a href="${out.pdf_url}" target="_blank" rel="noopener">PDF</a>`);
          const hash = out.hash ? `<div class="muted">Hash: ${out.hash}</div>` : '';
          const ts = out.generated_at ? `<div class="muted">Generated: ${out.generated_at}</div>` : '';
          exportResult.innerHTML = (links.length ? 'Download: ' + links.join(' · ') : 'No files generated') + hash + ts;
        } catch (err) {
          exportResult.textContent = String(err.message || err);
        }
      });
    </script>
  </body>
  </html>
